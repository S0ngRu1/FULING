<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赋灵 - AI角色扮演</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义样式 */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 防止页面滚动 */
        }
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        /* 麦克风聆听动画 */
        .listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
    </style>
</head>
<body class="bg-[#0D0D1A] text-white font-sans flex antialiased">

    <!-- 左侧固定导航栏 -->
    <nav class="w-64 h-full bg-[#1A1A2E] p-4 flex flex-col shrink-0">
        <div class="text-2xl font-bold text-yellow-400 mb-10">赋灵</div>
        <div class="flex flex-col space-y-4">
            <a href="#" id="nav-discover" class="flex items-center space-x-3 p-2 rounded-lg bg-yellow-400/10 text-yellow-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                <span>发现</span>
            </a>
            <a href="#" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-white/10 text-white/70">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m-7-7h14" /></svg>
                <span>创建</span>
            </a>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div id="main-content" class="flex-1 h-full overflow-y-auto custom-scrollbar">

        <!-- 角色列表页面 -->
        <div id="character-list-page" class="p-8">
            <header class="mb-8">
                <h1 class="text-3xl font-bold">发现角色</h1>
            </header>
            <main id="character-list-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- 角色卡片将由JS动态生成 -->
            </main>
        </div>

        <!-- 聊天页面 (默认隐藏) -->
        <div id="chat-page" class="hidden h-full flex flex-col">
            <!-- 聊天头部 -->
            <header id="chat-header" class="p-4 border-b border-white/10 flex items-center shrink-0">
                <!-- 头部内容将由JS动态生成 -->
            </header>
            <!-- 聊天消息区 -->
            <main id="chat-messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                <!-- 消息将由JS动态生成 -->
            </main>
            <!-- 聊天输入区 -->
            <footer class="p-4 border-t border-white/10 shrink-0">
                <form id="chat-form" class="flex items-center bg-gray-800 rounded-xl p-2 gap-2">
                    <button type="button" id="mic-button" class="bg-transparent text-white/70 hover:text-yellow-400 p-2.5 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <input id="chat-input" type="text" placeholder="输入消息或点击麦克风..." class="w-full bg-transparent px-4 py-2 text-white placeholder-gray-400 focus:outline-none">
                    <button type="submit" id="send-button" class="bg-yellow-500 rounded-lg p-2.5 hover:bg-yellow-400 disabled:bg-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7 7-7" /></svg>
                    </button>
                </form>
            </footer>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全局状态和配置 ---
            const API_BASE_URL = 'http://localhost:5000';
            let allCharacters = [];
            let currentCharacter = null;
            let chatHistory = [];
            let isLoading = false;
            let recognition; // 语音识别实例

            // --- DOM 元素获取 ---
            const characterListPage = document.getElementById('character-list-page');
            const chatPage = document.getElementById('chat-page');
            const characterListContainer = document.getElementById('character-list-container');
            const chatHeader = document.getElementById('chat-header');
            const chatMessagesContainer = document.getElementById('chat-messages-container');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const micButton = document.getElementById('mic-button');
            const navDiscover = document.getElementById('nav-discover');

            // --- 语音功能模块 ---

            /**
             * 文本转语音 (TTS)
             * @param {string} text 要朗读的文本
             */
            function speakText(text) {
                // 在朗读前停止任何正在进行的朗读
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN'; // 设置语言
                window.speechSynthesis.speak(utterance);
            }

            /**
             * 初始化语音识别 (STT)
             */
            function setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn("您的浏览器不支持语音识别。");
                    micButton.disabled = true;
                    micButton.style.display = 'none'; // 如果不支持，直接隐藏按钮
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    micButton.classList.add('listening', 'text-yellow-400');
                };

                recognition.onend = () => {
                    micButton.classList.remove('listening', 'text-yellow-400');
                };

                recognition.onerror = (event) => {
                    console.error("语音识别错误:", event.error);
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    chatInput.value = speechResult;
                    // 自动发送识别出的文本
                    handleSendMessage(new Event('submit'));
                };
            }

            // --- 核心功能函数 ---

            /**
             * 渲染角色列表
             */
            function renderCharacterList() {
                characterListContainer.innerHTML = ''; // 清空现有列表
                allCharacters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = "group block bg-white/5 rounded-xl hover:bg-white/10 transition-all duration-300 transform hover:-translate-y-1 border border-transparent hover:border-yellow-400/50 overflow-hidden cursor-pointer";
                    card.innerHTML = `
                        <div class="aspect-w-3 aspect-h-4 w-full">
                            <img src="${char.imageUrl}" alt="${char.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg text-white truncate">${char.name}</h3>
                            <p class="text-sm text-white/60 line-clamp-2 mt-1">${char.description}</p>
                        </div>
                    `;
                    card.addEventListener('click', () => showChatPage(char.id));
                    characterListContainer.appendChild(card);
                });
            }

            /**
             * 渲染聊天消息
             */
            function renderMessages() {
                chatMessagesContainer.innerHTML = '';
                chatHistory.forEach(msg => {
                    const messageWrapper = document.createElement('div');
                    const isUser = msg.role === 'user';
                    messageWrapper.className = `flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`;

                    const avatarUrl = isUser ? "https://placehold.co/40x40/FBBF24/000000?text=我" : currentCharacter.imageUrl;

                    messageWrapper.innerHTML = `
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover shrink-0" />
                        <div class="max-w-xl p-3 rounded-xl ${isUser ? 'bg-yellow-500 text-black' : 'bg-gray-700'}">
                            <p style="white-space: pre-wrap;">${msg.content}</p>
                        </div>
                    `;
                    chatMessagesContainer.appendChild(messageWrapper);
                });

                if (isLoading) {
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'flex gap-3';
                    loadingIndicator.innerHTML = `
                        <img src="${currentCharacter.imageUrl}" class="w-10 h-10 rounded-full object-cover" />
                        <div class="max-w-xl p-3 rounded-xl bg-gray-700 flex items-center">
                            <span class="h-2 w-2 bg-white rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                            <span class="h-2 w-2 bg-white rounded-full animate-bounce mx-1" style="animation-delay: -0.15s;"></span>
                            <span class="h-2 w-2 bg-white rounded-full animate-bounce"></span>
                        </div>
                    `;
                    chatMessagesContainer.appendChild(loadingIndicator);
                }
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }

            /**
             * 显示聊天页面
             * @param {string} characterId
             */
            function showChatPage(characterId) {
                currentCharacter = allCharacters.find(c => c.id === characterId);
                if (!currentCharacter) return;

                window.speechSynthesis.cancel(); // 切换角色时停止说话
                chatHistory = [];
                isLoading = false;

                characterListPage.classList.add('hidden');
                chatPage.classList.remove('hidden');

                chatHeader.innerHTML = `
                    <button id="back-to-list-button" class="text-2xl hover:text-yellow-300 transition-colors mr-4">&larr;</button>
                    <img src="${currentCharacter.imageUrl}" class="w-12 h-12 rounded-full object-cover mr-4" />
                    <div>
                        <h2 class="text-xl font-bold">${currentCharacter.name}</h2>
                        <p class="text-sm text-white/60">${currentCharacter.description}</p>
                    </div>
                `;

                document.getElementById('back-to-list-button').addEventListener('click', showListPage);

                renderMessages();
                chatInput.focus();
            }

            /**
             * 返回角色列表页面
             */
            function showListPage() {
                window.speechSynthesis.cancel(); // 返回时停止说话
                chatPage.classList.add('hidden');
                characterListPage.classList.remove('hidden');
                currentCharacter = null;
            }

            /**
             * 发送消息的处理函数
             * @param {Event} event
             */
            async function handleSendMessage(event) {
                event.preventDefault();
                const userInput = chatInput.value.trim();
                if (!userInput || isLoading) return;

                chatHistory.push({ role: 'user', content: userInput });
                chatInput.value = '';
                isLoading = true;
                sendButton.disabled = true;
                micButton.disabled = true;
                renderMessages();

                const historyForApi = chatHistory.slice(0, -1).map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));

                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            characterId: currentCharacter.id,
                            message: userInput,
                            history: historyForApi
                        })
                    });

                    if (!response.ok) throw new Error(`API error: ${response.status}`);

                    const data = await response.json();
                    chatHistory.push({ role: 'assistant', content: data.responseText });

                    // *** 新增：朗读AI的回复 ***
                    speakText(data.responseText);

                } catch (error) {
                    console.error("发送消息失败:", error);
                    const errorText = '抱歉，我好像断线了... 请稍后再试。';
                    chatHistory.push({ role: 'assistant', content: errorText });
                    speakText(errorText); // 同样朗读错误信息
                } finally {
                    isLoading = false;
                    sendButton.disabled = false;
                    micButton.disabled = false;
                    renderMessages();
                    chatInput.focus();
                }
            }

            // --- 初始化和事件绑定 ---

            async function init() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/characters`);
                    if (!response.ok) throw new Error('无法加载角色列表');
                    allCharacters = await response.json();
                    renderCharacterList();
                    setupSpeechRecognition(); // 初始化语音识别
                } catch (error) {
                    console.error(error);
                    characterListContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${error.message}</p>`;
                }
            }

            chatForm.addEventListener('submit', handleSendMessage);

            micButton.addEventListener('click', () => {
                if (recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("无法启动语音识别:", e);
                    }
                }
            });

            navDiscover.addEventListener('click', (e) => {
                e.preventDefault();
                showListPage();
            });

            init();
        });
    </script>

</body>
</html>

